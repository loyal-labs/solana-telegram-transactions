name: React Doctor

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "app/**"

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  react-doctor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: anthropics/claude-code-action@v1
        id: doctor
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Run react-doctor on the app directory, scanning only files changed in this PR.

            Execute this command:
            ```
            npx -y react-doctor@latest ./app --diff origin/${{ github.base_ref }} --verbose
            ```

            After the scan completes, format your response as:

            ## React Doctor Score: **X/100**

            | Category | Issues |
            |----------|--------|
            | ... | ... |

            ### Top 5 Issues
            1. ...

            Where X is the actual score from the scan.

            If the command fails or produces no output, report that react-doctor
            could not run and include the error message.
          claude_args: >-
            --model claude-sonnet-4-6
            --max-turns 5
            --allowedTools "Bash(npx*)"

      - name: Post score to PR
        if: always() && steps.doctor.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          jq -r '.result // empty' /home/runner/work/_temp/claude-execution-output.json > /tmp/comment-body.md
          if [ -s /tmp/comment-body.md ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/comment-body.md
          fi
